# Generated by nginxconfig.io
# See nginxconfig.txt for the configuration share link
# nginx.conf
# user                                                    nginx;
pid                                                     /var/run/nginx.pid;
worker_processes                                        auto;
worker_rlimit_nofile                                    65535;

# Load modules
# include                                                 /etc/nginx/modules-enabled/*.conf;
# https://docs.nginx.com/nginx/admin-guide/dynamic-modules/geoip2/
# load_module                                             modules/ngx_http_geoip2_module.so;
# load_module                                             modules/ngx_stream_geoip2_module.so;
# https://docs.nginx.com/nginx/admin-guide/dynamic-modules/brotli/
load_module                                             modules/ngx_http_brotli_filter_module.so;
load_module                                             modules/ngx_http_brotli_static_module.so;

events {
    accept_mutex                                        off;

    # accept as many connections as possible, may flood worker connections if set too low -- for testing environment
    multi_accept                                        off;

    # determines how much clients will be served per worker
    # max clients = worker_connections * worker_processes
    # max clients is also limited by the number of socket connections available on the system (~64k)
    worker_connections                                  65535;

    # optimized to serve many clients with each thread, essential for linux -- for testing environment
    use                                                 epoll;
}

http {
    charset                                             utf-8;
    log_not_found                                       off;

    types_hash_max_size                                 2048;
    types_hash_bucket_size                              128;

    client_max_body_size                                16M;

    # MIME
    include                                             mime.types;
    default_type                                        application/octet-stream;

    # Logging
    access_log                                          off;
    error_log                                           /var/log/nginx/error.log;

    # server will close connection after this time -- default 75
    keepalive_timeout                                   128;
    keepalive_requests                                  100000;

    # Optimizing Performance for Serving Content
    # https://docs.nginx.com/nginx/admin-guide/web-server/serving-static-content/
    # copies data between one FD and other from within the kernel
    # faster than read() + write()
    sendfile                                            on;
    sendfile_max_chunk                                  5m;

    # if client stop responding, free up memory -- default 60
    send_timeout                                        60;

    # send headers in one piece, it is better than sending them one by one
    tcp_nopush                                          on;

    # don't buffer data sent, good for small data bursts in real time
    tcp_nodelay                                         on;

    # security, reveal less information about ourselves
    # disables emitting nginx version in error messages and in the “Server” response header field
    server_tokens                                       off;

    # SSL
    ssl_session_cache                                   shared:SSL:50m;
    ssl_session_timeout                                 1d;
    ssl_session_tickets                                 off;

    # Diffie-Hellman parameter for DHE ciphersuites. SSL configurations, including strong ciphers.
    # https://scaron.info/blog/improve-your-nginx-ssl-configuration.html
    # openssl dhparam -out /etc/nginx/ssl/dhparam.pem 4096
    ssl_dhparam                                         /etc/nginx/ssl/dhparams.pem;

    # Mozilla Intermediate configuration
    ssl_protocols                                       TLSv1.2 TLSv1.3;
    ssl_ciphers                                         ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers                           off;

    # 0-RTT QUIC connection resumption
    ssl_early_data                                      on;

    # OCSP Stapling
    ssl_stapling                                        on;
    ssl_stapling_verify                                 on;
    resolver                                            1.1.1.1 1.0.0.1 8.8.8.8 8.8.4.4 208.67.222.222 208.67.220.220 valid=300s;
    resolver_timeout                                    30s;

    # enable response compression
    gzip                                                on;
    brotli                                              on; # https://docs.nginx.com/nginx/admin-guide/dynamic-modules/brotli/

    # Load configs
    include                                             /etc/nginx/conf.d/*.conf;
    include                                             /etc/nginx/sites-enabled/*;
}
