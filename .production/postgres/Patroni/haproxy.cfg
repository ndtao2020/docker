global
  log stdout format raw daemon
  maxconn 4096

defaults
  log     global
  option  dontlognull
  retries 3
  timeout connect 5s
  timeout client  30s
  timeout server  30s

# Patroni REST runs on 8008; PostgreSQL runs on 5432
# --- WRITE (leader) endpoint on 5432 ---
frontend fe_write
  bind *:5432
  default_backend be_write

backend be_write
  mode tcp
  balance roundrobin
  option tcp-check
  # Check Patroni REST to route only to the leader
  # We tunnel an HTTP check over TCP using 'option httpchk'
  option httpchk GET /master HTTP/1.1\r\nHost:\ localhost
  http-check expect status 200
  server patroni1 patroni-1:5432 check inter 2s fall 3 rise 2
  server patroni2 patroni-2:5432 check inter 2s fall 3 rise 2
  server patroni3 patroni-3:5432 check inter 2s fall 3 rise 2

# --- READ-ONLY (replicas) endpoint on 5433 ---
frontend fe_readonly
  bind *:5433
  default_backend be_readonly

backend be_readonly
  mode tcp
  balance roundrobin
  option tcp-check
  option httpchk GET /replica HTTP/1.1\r\nHost:\ localhost
  http-check expect status 200
  server patroni1 patroni-1:5432 check inter 2s fall 3 rise 2
  server patroni2 patroni-2:5432 check inter 2s fall 3 rise 2
  server patroni3 patroni-3:5432 check inter 2s fall 3 rise 2

# Health endpoint for LB status
frontend fe_stats
  bind *:7000
  stats enable
  stats uri /
  stats refresh 5s
